<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sori Listening Test</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .hidden { display: none; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        .button { 
            padding: 10px 20px; 
            margin: 5px;
            background: #333; 
            color: white; 
            border: none; 
            cursor: pointer; 
        }
        .button:hover { background: #555; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .rating-scale { margin: 20px 0; }
        .rating-scale label { 
            display: inline-block; 
            margin: 0 10px; 
            padding: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        .rating-scale input[type="radio"]:checked + label {
            background: #333;
            color: white;
            border-color: #333;
        }
        .rating-scale input[type="radio"] { display: none; }
        .progress { 
            margin: 20px 0; 
            font-family: monospace;
            font-size: 14px;
            white-space: pre;
        }
        audio { width: 100%; margin: 10px 0; }
    </style>
</head>
<body>
    <!-- Consent Page -->
    <div id="consent-page" class="container">
        <h1>Research Study Consent Form</h1>
        
        <h2>Study Title: Evaluation of AI-Generated Music Quality</h2>
        
        <div class="section">
            <h3>Principal Investigator</h3>
            <p>Kyogu Lee, Seoul National University, Department of Intelligence and Information</p>
            <p>IRB No: 2512/003-007</p>
        </div>
        
        <div class="section">
            <h3>Purpose of the Study</h3>
            <p>This study aims to evaluate the quality of AI-generated music transformation systems.</p>
        </div>
        
        <div class="section">
            <h3>What You Will Do</h3>
            <p>You will listen to audio samples and rate them on two criteria:</p>
            <ul>
                <li>Input Correspondence: How well output matches input timing and pitch</li>
                <li>Musical Quality: How natural and musical the output sounds</li>
            </ul>
            <p>Total time: Approximately 90 minutes</p>
            <p>Total samples: 520 audio samples (260 per evaluation type)</p>
        </div>
        
        <div class="section">
            <h3>Requirements</h3>
            <ul>
                <li>You must be 18 years of age or older</li>
                <li>You must have normal hearing</li>
                <li>You must use headphones or earphones (REQUIRED)</li>
                <li>You must work in a quiet environment</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>Risks and Benefits</h3>
            <p>There are no known risks associated with this study.</p>
            <p>Compensation: ¬£12.50 upon completion</p>
        </div>
        
        <div class="section">
            <h3>Confidentiality</h3>
            <p>Your responses will be kept confidential. Data will be stored securely and used only for research purposes.</p>
        </div>
        
        <div class="section">
            <h3>Voluntary Participation</h3>
            <p>Your participation is voluntary. You may withdraw at any time without penalty.</p>
        </div>
        
        <div class="section">
            <label>
                <input type="checkbox" id="consent-checkbox">
                I have read and understood the above information. I agree to participate in this study.
            </label>
        </div>
        
        <button type="button" class="button" onclick="acceptConsent()">Continue to Instructions</button>
    </div>

    <!-- Instructions Page -->
    <div id="instructions-page" class="container hidden">
        <h1>Instructions</h1>
        
        <div class="section">
            <h3>Overview</h3>
            <p>You will complete two types of evaluations:</p>
            <ol>
                <li><strong>Input Correspondence (IC):</strong> Rate how well the output music matches the input audio in timing and pitch</li>
                <li><strong>Musical Quality (MQ):</strong> Rate how natural and musically plausible the output sounds</li>
            </ol>
            <p>Each evaluation consists of 20 sessions with 13 samples per session (260 samples total per evaluation).</p>
        </div>
        
        <div class="section">
            <h3>Input Correspondence (IC) Evaluation</h3>
            <p><strong>Audio Format:</strong> STEREO - LEFT channel is input audio, RIGHT channel is output music</p>
            <p><strong>Question:</strong> How well does the output music match the timing and pitch of the input audio?</p>
            <p><strong>Rating Scale:</strong></p>
            <ul>
                <li>1 - Not at all</li>
                <li>2 - Slightly</li>
                <li>3 - Moderately</li>
                <li>4 - Very well</li>
                <li>5 - Perfectly</li>
            </ul>
            <p><strong>IMPORTANT:</strong> You MUST use headphones to properly distinguish left and right channels.</p>
        </div>
        
        <div class="section">
            <h3>Musical Quality (MQ) Evaluation</h3>
            <p><strong>Audio Format:</strong> MONO - single channel output</p>
            <p><strong>Question:</strong> How musically plausible and natural does this output sound?</p>
            <p><strong>Rating Scale:</strong></p>
            <ul>
                <li>1 - Very unnatural</li>
                <li>2 - Somewhat unnatural</li>
                <li>3 - Neutral</li>
                <li>4 - Somewhat natural</li>
                <li>5 - Very natural</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>Important Notes</h3>
            <ul>
                <li>Some samples may produce little or no musical output - this is valid, rate based on what you hear</li>
                <li>You can go back and change previous ratings</li>
                <li>Take breaks between sessions as needed</li>
                <li>Work in a quiet environment</li>
                <li>Complete the study in one sitting if possible</li>
            </ul>
        </div>
        
        <button type="button" class="button" onclick="goBackToConsent()">Back</button>
        <button type="button" class="button" onclick="startEvaluation()">Start Evaluation</button>
    </div>

    <!-- Evaluation Page -->
    <div id="evaluation-page" class="container hidden">
        <h1 id="eval-title">Input Correspondence Evaluation</h1>
        <h2 id="session-info">Session 1 of 20</h2>
        
        <div class="progress">
            <div id="progress-text">Progress: 0%</div>
        </div>
        
        <div class="section">
            <p id="eval-instruction"></p>
            <p><strong>Note:</strong> Some samples may produce little or no musical output. This is valid - rate based on what you hear.</p>
        </div>
        
        <div class="section">
            <h3 id="sample-title">Sample 1</h3>
            <audio id="audio-player" controls></audio>
        </div>
        
        <div class="section">
            <h3 id="rating-question">How well does the output music match the timing and pitch of the input audio?</h3>
            <div class="rating-scale" id="rating-scale">
                <!-- Radio buttons will be dynamically generated -->
            </div>
            <p id="scale-labels"></p>
        </div>
        
        <div>
            <button type="button" class="button" onclick="goBack()">Previous</button>
            <button type="button" class="button" id="next-button" onclick="submitRating()" disabled>Next</button>
        </div>
    </div>

    <!-- Break Page -->
    <div id="break-page" class="container hidden">
        <h1>Take a Break</h1>
        <div class="section">
            <p>You have completed the Input Correspondence evaluation!</p>
            <p>Please take a 5-minute break before continuing to the Musical Quality evaluation.</p>
            <p><strong>Progress:</strong> 50% complete (260/520 samples)</p>
        </div>
        <button type="button" class="button" onclick="continueToMQ()">Continue to Musical Quality Evaluation</button>
    </div>

    <!-- Completion Page -->
    <div id="completion-page" class="container hidden">
        <h1>Evaluation Complete!</h1>
        <div class="section">
            <h3>Thank you for your participation</h3>
            <p>You have successfully completed all evaluations.</p>
            <p>Total samples evaluated: 520</p>
            <p id="email-status" style="font-weight: bold; color: #ff6600;">üìä Saving data to Google Sheets...</p>
            <div id="redirect-controls" class="hidden" style="margin-top: 30px;">
                <button type="button" class="button" onclick="redirectToProlific()">Continue to Prolific</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_URL = 'https://raw.githubusercontent.com/sori-experiment/sori-listening-test/main';
        const TOTAL_SESSIONS = 20;
        const SAMPLES_PER_SESSION = 13;
        
        // Google Sheets Apps Script URL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxAu5tNVQbC38zOcXZHdFlsBfVJoAhHuYODZcXNn1YsfsfG70lfVWAwGlWrqJMB8bFtNQ/exec';
        
        // Get Prolific IDs from URL
        const urlParams = new URLSearchParams(window.location.search);
        const prolificID = urlParams.get('PROLIFIC_PID') || urlParams.get('prolific_pid');
        const studyID = urlParams.get('STUDY_ID') || urlParams.get('study_id');
        const sessionID = urlParams.get('SESSION_ID') || urlParams.get('session_id');
        
        // Check if accessed through Prolific
        if (!prolificID || prolificID === 'test' || prolificID === 'fake' || prolificID.length < 10) {
            document.body.innerHTML = `
                <div style="max-width: 600px; margin: 100px auto; padding: 40px; text-align: center; font-family: Arial, sans-serif;">
                    <h1 style="color: #d32f2f;">Access Denied</h1>
                    <p style="font-size: 18px; margin: 20px 0;">This study can only be accessed through Prolific.</p>
                    <p style="color: #666;">If you are a Prolific participant, please make sure you clicked the study link from your Prolific dashboard.</p>
                    <p style="margin-top: 40px; font-size: 14px; color: #999;">Study ID: Sori Music Evaluation</p>
                </div>
            `;
            throw new Error('Invalid access - Prolific ID required');
        }
        
        // State
        const state = {
            currentPage: 'consent',
            currentEvalType: 'IC',
            currentSession: 0,
            currentSample: 0,
            sessionOrder: [],
            responses: { IC: [], MQ: [] },
            startTime: Date.now(),
            prolificID: prolificID,
            studyID: studyID || 'unknown',
            sessionID: sessionID || 'unknown'
        };
        
        // Sample order
        const SAMPLE_MODELS = [
            { model: 'baseline_basic_pitch', cfg: null },
            { model: 'baseline_deep_salience', cfg: null },
            { model: 'sori_adv', cfg: 0.0 },
            { model: 'sori_adv', cfg: 0.5 },
            { model: 'sori_adv', cfg: 1.0 },
            { model: 'sori_adv', cfg: 2.0 },
            { model: 'sori_adv', cfg: 3.0 },
            { model: 'sori_noadv', cfg: 0.0 },
            { model: 'sori_noadv', cfg: 0.5 },
            { model: 'sori_noadv', cfg: 1.0 },
            { model: 'sori_noadv', cfg: 2.0 },
            { model: 'sori_noadv', cfg: 3.0 },
            { model: 'baseline_timbre_trap', cfg: null }
        ];
        
        // Initialize
        function init() {
            shuffleSession();
        }
        
        function shuffleSession() {
            state.sessionOrder = [...Array(SAMPLES_PER_SESSION).keys()].sort(() => Math.random() - 0.5);
        }
        
        function createProgressBar(percent) {
            const width = 30;
            const filled = Math.max(1, Math.ceil((percent / 100) * width));
            const empty = width - filled;
            const bar = '[' + '‚ñà'.repeat(filled) + '‚ñë'.repeat(empty) + ']';
            return bar + ' ' + percent + '%';
        }
        
        function createRatingButtons() {
            const evalType = state.currentEvalType;
            const session = state.currentSession;
            const sample = state.currentSample;
            const uniqueName = 'rating_' + evalType + '_' + session + '_' + sample;
            
            const container = document.getElementById('rating-scale');
            container.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = uniqueName;
                input.value = i;
                input.id = 'r_' + uniqueName + '_' + i;
                
                const label = document.createElement('label');
                label.setAttribute('for', input.id);
                label.textContent = i;
                
                input.addEventListener('change', () => {
                    document.getElementById('next-button').disabled = false;
                });
                
                container.appendChild(input);
                container.appendChild(label);
            }
        }
        
        function acceptConsent() {
            if (!document.getElementById('consent-checkbox').checked) {
                alert('Please check the consent box to continue.');
                return;
            }
            showPage('instructions');
        }
        
        function goBackToConsent() {
            showPage('consent');
        }
        
        function startEvaluation() {
            showPage('evaluation');
            updateEvaluationUI();
        }
        
        function showPage(page) {
            document.getElementById('consent-page').classList.add('hidden');
            document.getElementById('instructions-page').classList.add('hidden');
            document.getElementById('evaluation-page').classList.add('hidden');
            document.getElementById('break-page').classList.add('hidden');
            document.getElementById('completion-page').classList.add('hidden');
            
            if (page === 'consent') {
                document.getElementById('consent-page').classList.remove('hidden');
            } else if (page === 'instructions') {
                document.getElementById('instructions-page').classList.remove('hidden');
            } else if (page === 'evaluation') {
                document.getElementById('evaluation-page').classList.remove('hidden');
            } else if (page === 'break') {
                document.getElementById('break-page').classList.remove('hidden');
            } else if (page === 'completion') {
                document.getElementById('completion-page').classList.remove('hidden');
                finalizeData();
            }
            state.currentPage = page;
        }
        
        function updateEvaluationUI() {
            const evalType = state.currentEvalType;
            const session = state.currentSession + 1;
            const sampleNum = state.currentSample + 1;
            const sampleIndex = state.sessionOrder[state.currentSample];
            
            createRatingButtons();
            
            if (evalType === 'IC') {
                document.getElementById('eval-title').textContent = 'Input Correspondence Evaluation';
                document.getElementById('rating-question').textContent = 'How well does the output music match the timing and pitch of the input audio?';
                document.getElementById('eval-instruction').textContent = 'Listen to the STEREO audio. LEFT channel is input, RIGHT channel is output.';
                document.getElementById('scale-labels').textContent = '1=Not at all, 2=Slightly, 3=Moderately, 4=Very well, 5=Perfectly';
            } else {
                document.getElementById('eval-title').textContent = 'Musical Quality Evaluation';
                document.getElementById('rating-question').textContent = 'How musically plausible and natural does this output sound?';
                document.getElementById('eval-instruction').textContent = 'Listen to the MONO audio output.';
                document.getElementById('scale-labels').textContent = '1=Very unnatural, 2=Somewhat unnatural, 3=Neutral, 4=Somewhat natural, 5=Very natural';
            }
            
            document.getElementById('session-info').textContent = 'Session ' + session + ' of ' + TOTAL_SESSIONS;
            document.getElementById('sample-title').textContent = 'Sample ' + sampleNum;
            
            const totalSamples = TOTAL_SESSIONS * SAMPLES_PER_SESSION;
            const completed = state.responses[evalType].flat().length;
            const progress = Math.round((completed / totalSamples) * 100);
            const progressBar = createProgressBar(progress);
            document.getElementById('progress-text').innerHTML = '<code style="font-family: monospace; white-space: pre;">' + progressBar + '</code><br>Sample ' + sampleNum + ' of ' + SAMPLES_PER_SESSION;
            
            const audioURL = getAudioURL(sampleIndex);
            document.getElementById('audio-player').src = audioURL;
            
            if (state.responses[evalType][state.currentSession]) {
                const prev = state.responses[evalType][state.currentSession].find(r => r.sampleIndex === sampleIndex);
                if (prev) {
                    const uniqueName = 'rating_' + evalType + '_' + state.currentSession + '_' + state.currentSample;
                    const radio = document.querySelector('input[name="' + uniqueName + '"][value="' + prev.rating + '"]');
                    if (radio) {
                        radio.checked = true;
                        document.getElementById('next-button').disabled = false;
                    }
                } else {
                    document.getElementById('next-button').disabled = true;
                }
            } else {
                document.getElementById('next-button').disabled = true;
            }
        }
        
        function getAudioURL(sampleIndex) {
            const evalType = state.currentEvalType.toLowerCase();
            const session = String(state.currentSession + 1).padStart(2, '0');
            const sample = String(sampleIndex + 1).padStart(2, '0');
            const model = SAMPLE_MODELS[sampleIndex];
            
            let filename = evalType + '_session' + session + '_sample' + sample + '_' + model.model;
            if (model.cfg !== null) {
                filename += '_cfg' + model.cfg.toFixed(1);
            }
            filename += '.wav';
            
            return BASE_URL + '/' + evalType + '_evaluation/session_' + session + '/' + filename;
        }
        
        function submitRating() {
            const evalType = state.currentEvalType;
            const uniqueName = 'rating_' + evalType + '_' + state.currentSession + '_' + state.currentSample;
            const rating = document.querySelector('input[name="' + uniqueName + '"]:checked');
            if (!rating) return;
            
            const sampleIndex = state.sessionOrder[state.currentSample];
            
            if (!state.responses[evalType][state.currentSession]) {
                state.responses[evalType][state.currentSession] = [];
            }
            
            const existingIndex = state.responses[evalType][state.currentSession].findIndex(r => r.sampleIndex === sampleIndex);
            const responseData = {
                sampleIndex: sampleIndex,
                model: SAMPLE_MODELS[sampleIndex],
                rating: parseInt(rating.value),
                timestamp: Date.now()
            };
            
            if (existingIndex >= 0) {
                state.responses[evalType][state.currentSession][existingIndex] = responseData;
            } else {
                state.responses[evalType][state.currentSession].push(responseData);
            }
            
            if (state.currentSample < SAMPLES_PER_SESSION - 1) {
                state.currentSample++;
                updateEvaluationUI();
            } else if (state.currentSession < TOTAL_SESSIONS - 1) {
                state.currentSession++;
                state.currentSample = 0;
                shuffleSession();
                updateEvaluationUI();
            } else {
                completeEvalType();
            }
        }
        
        function goBack() {
            if (state.currentSample > 0) {
                state.currentSample--;
                updateEvaluationUI();
            } else if (state.currentSession > 0) {
                state.currentSession--;
                state.currentSample = SAMPLES_PER_SESSION - 1;
                updateEvaluationUI();
            } else {
                showPage('instructions');
            }
        }
        
        function completeEvalType() {
            if (state.currentEvalType === 'IC') {
                showPage('break');
            } else {
                showPage('completion');
            }
        }
        
        function continueToMQ() {
            state.currentEvalType = 'MQ';
            state.currentSession = 0;
            state.currentSample = 0;
            shuffleSession();
            showPage('evaluation');
            updateEvaluationUI();
        }
        
        function finalizeData() {
            const completionTime = Math.round((Date.now() - state.startTime) / 60000);
            
            const finalData = {
                prolificID: state.prolificID,
                studyID: state.studyID,
                sessionID: state.sessionID,
                completionTime: completionTime,
                ic_responses: state.responses.IC,
                mq_responses: state.responses.MQ,
                timestamp: new Date().toISOString()
            };
            
            // DEBUG logging
            console.log('=== SENDING TO GOOGLE SHEETS ===');
            console.log('URL:', GOOGLE_SHEETS_URL);
            console.log('Data:', finalData);
            console.log('Data size:', JSON.stringify(finalData).length, 'characters');
            
            // Send to Google Sheets with no-cors
            fetch(GOOGLE_SHEETS_URL, {
                method: "POST",
                mode: "no-cors",  // CORS Ïö∞Ìöå
                headers: {
                    "Content-Type": "text/plain"  // no-corsÏóêÏÑúÎäî text/plain ÏÇ¨Ïö©
                },
                body: JSON.stringify(finalData)
            })
            .then((response) => {
                // no-cors Î™®ÎìúÏóêÏÑúÎäî responseÎ•º ÏùΩÏùÑ Ïàò ÏóÜÏùå!
                // ÌïòÏßÄÎßå Ïó¨Í∏∞ÍπåÏßÄ ÏôîÎã§Îäî Í≤ÉÏùÄ ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°Îê®
                console.log('=== REQUEST SENT ===');
                console.log('Response type:', response.type);  // "opaque"
                
                // ÏÑ±Í≥µÏúºÎ°ú Í∞ÑÏ£º
                document.getElementById('email-status').innerHTML = '‚úÖ <span style="color: green;">Data sent! Check Google Sheets to confirm.</span>';
                document.getElementById('redirect-controls').classList.remove('hidden');
            })
            .catch((error) => {
                // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨Îßå Ïó¨Í∏∞ÏÑú Ïû°Ìûò
                console.error('=== NETWORK ERROR ===');
                console.error('Error:', error);
                
                document.getElementById('email-status').innerHTML = '‚ùå <span style="color: red;">Network error: ' + error.message + '</span>';
                document.getElementById('redirect-controls').classList.remove('hidden');
                alert('Network error. Please contact researcher.\n\nError: ' + error.message);
            });
        }
        
        function redirectToProlific() {
            window.location.href = 'https://app.prolific.com/submissions/complete?cc=C174E71H';
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
